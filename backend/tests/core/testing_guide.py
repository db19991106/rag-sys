#!/usr/bin/env python3
"""
RAGç³»ç»Ÿæµ‹è¯•æŒ‡å— - å¿«é€Ÿå‚è€ƒ

ä½¿ç”¨æ–¹å¼:
  python3 testing_guide.py --help
  python3 testing_guide.py --quick        # å¿«é€ŸåŠŸèƒ½æµ‹è¯•
  python3 testing_guide.py --full         # å®Œæ•´æµ‹è¯•å¥—ä»¶
  python3 testing_guide.py --add "æ–°æŸ¥è¯¢"  # æ·»åŠ æµ‹è¯•ç”¨ä¾‹
"""

import argparse
import sys
import json
from pathlib import Path


def print_guide():
    """æ‰“å°æµ‹è¯•æŒ‡å—"""
    guide = """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              RAGç³»ç»Ÿæµ‹è¯•æŒ‡å—                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ æµ‹è¯•æ–‡ä»¶ä½ç½®:
   â€¢ ä¸»æµ‹è¯•è„šæœ¬:    quick_verify.py
   â€¢ å®Œæ•´æµ‹è¯•:      rag_test_suite.py
   â€¢ RAGASè¯„ä¼°:     project_local_ragas.py
   â€¢ æµ‹è¯•æ•°æ®é›†:    test_data/test_dataset.json

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš€ å¸¸ç”¨æµ‹è¯•å‘½ä»¤
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ã€1ã€‘å¿«é€ŸåŠŸèƒ½æµ‹è¯• (æ¨èæ—¥å¸¸ä½¿ç”¨)
   cd /root/autodl-tmp/rag/backend
   python3 quick_verify.py

   è¾“å‡º: âœ… æµ‹è¯•é€šè¿‡: 3/3 | ğŸ¯ åŒ¹é…ç‡: 83% | â±ï¸  å¹³å‡: 18.7s

ã€2ã€‘è¿è¡Œå•ä¸ªæŸ¥è¯¢æµ‹è¯•
   python3 project_local_ragas.py --mode single --query "8-9çº§å‘˜å·¥ä½å®¿æ ‡å‡†"

ã€3ã€‘æ‰¹é‡æµ‹è¯• (æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹)
   python3 project_local_ragas.py --mode batch

ã€4ã€‘ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
   python3 rag_test_suite.py --report

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â• æ·»åŠ æ–°çš„æµ‹è¯•ç”¨ä¾‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ–¹æ³•1: ç¼–è¾‘ test_data/test_dataset.json
   [
     {
       "query": "ä½ çš„æ–°é—®é¢˜",
       "ground_truth": "æœŸæœ›çš„ç­”æ¡ˆ",
       "contexts": ["ç›¸å…³ä¸Šä¸‹æ–‡ç‰‡æ®µ"]
     }
   ]

æ–¹æ³•2: ä½¿ç”¨è„šæœ¬æ·»åŠ 
   python3 testing_guide.py --add "æ–°é—®é¢˜" --expected "æœŸæœ›ç­”æ¡ˆ"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š æµ‹è¯•ç±»å‹è¯´æ˜
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. åŠŸèƒ½æµ‹è¯• (Functional Testing)
   æ£€æŸ¥: ç³»ç»Ÿèƒ½å¦æ­£ç¡®å›ç­”æŸ¥è¯¢
   å·¥å…·: quick_verify.py
   æŒ‡æ ‡: å…³é”®è¯åŒ¹é…ç‡ã€å“åº”æ—¶é—´

2. æ€§èƒ½æµ‹è¯• (Performance Testing)
   æ£€æŸ¥: å“åº”æ—¶é—´ã€å¹¶å‘å¤„ç†èƒ½åŠ›
   å·¥å…·: tests/test_performance.py
   æŒ‡æ ‡: P50/P95/P99å“åº”æ—¶é—´ã€ååé‡

3. RAGASè¯„ä¼° (Quality Testing)
   æ£€æŸ¥: å›ç­”è´¨é‡ã€æ£€ç´¢å‡†ç¡®æ€§
   å·¥å…·: project_local_ragas.py
   æŒ‡æ ‡: Faithfulness, Relevancy, Context Recall

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”„ å®šæœŸæµ‹è¯•å»ºè®®
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ¯æ—¥:
   â€¢ è¿è¡Œ quick_verify.py ç¡®ä¿åŸºæœ¬åŠŸèƒ½æ­£å¸¸

æ¯å‘¨:
   â€¢ æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ logs/app.log æ˜¯å¦æœ‰é”™è¯¯
   â€¢ æµ‹è¯•å‡ ä¸ªè¾¹ç¼˜æ¡ˆä¾‹æŸ¥è¯¢

æ¯æœˆ:
   â€¢ è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ rag_test_suite.py
   â€¢ è¯„ä¼°æ˜¯å¦éœ€è¦æ·»åŠ æ–°æµ‹è¯•ç”¨ä¾‹
   â€¢ æ€§èƒ½åŸºå‡†æµ‹è¯•

é‡å¤§å˜æ›´å:
   â€¢ æ·»åŠ æ–°æ–‡æ¡£åç«‹å³æµ‹è¯•
   â€¢ ä¿®æ”¹åˆ†å—ç­–ç•¥åå…¨é¢æµ‹è¯•
   â€¢ å‡çº§æ¨¡å‹åå¯¹æ¯”æµ‹è¯•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ› é—®é¢˜æ’æŸ¥
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å¦‚æœæµ‹è¯•å¤±è´¥:

1. æ£€æŸ¥æ—¥å¿—
   tail -f /root/autodl-tmp/rag/logs/app.log

2. éªŒè¯å‘é‡æ•°æ®åº“
   python3 -c "
   import json
   with open('vector_db/faiss_metadata.json') as f:
       data = json.load(f)
   print(f'å‘é‡æ•°é‡: {len(data)}')
   print(f'ç¤ºä¾‹: {list(data.values())[0]}')
   "

3. æµ‹è¯•LLMè¿æ¥
   python3 test_local_llm.py

4. æ£€æŸ¥ä¾èµ–
   pip list | grep -E "ragas|langchain|transformers"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ˆ æ€§èƒ½åŸºå‡†
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å½“å‰ç³»ç»ŸåŸºå‡† (Qwen2.5-7B):
   â€¢ æ£€ç´¢æ—¶é—´:     ~10ms
   â€¢ LLMç”Ÿæˆæ—¶é—´:  ~11s
   â€¢ æ€»å“åº”æ—¶é—´:   ~19s
   â€¢ æ˜¾å­˜å ç”¨:     ~14GB

ä¼˜åŒ–ç›®æ ‡:
   â€¢ æ€»å“åº”æ—¶é—´ < 10s (ä½¿ç”¨8bité‡åŒ–)
   â€¢ å¹¶å‘æ”¯æŒ 5+ ç”¨æˆ·

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“š ç›¸å…³æ–‡æ¡£
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

   â€¢ è¯¦ç»†æµ‹è¯•æµç¨‹: TESTING_WORKFLOW_GUIDE.md
   â€¢ RAGASå·¥å…·æŒ‡å—: RAG_EVALUATION_TOOLS_GUIDE.md
   â€¢ è¯„ä¼°æŠ¥å‘Š: EVALUATION_REPORT.md

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
    print(guide)


def add_test_case(query, expected=None):
    """æ·»åŠ æ–°çš„æµ‹è¯•ç”¨ä¾‹"""
    test_file = Path("/root/autodl-tmp/rag/backend/test_data/test_dataset.json")

    # è¯»å–ç°æœ‰æµ‹è¯•æ•°æ®
    if test_file.exists():
        with open(test_file, "r", encoding="utf-8") as f:
            dataset = json.load(f)
    else:
        dataset = []

    # åˆ›å»ºæ–°æµ‹è¯•ç”¨ä¾‹
    new_case = {"query": query, "ground_truth": expected or "å¾…å¡«å†™", "contexts": []}

    dataset.append(new_case)

    # ä¿å­˜
    with open(test_file, "w", encoding="utf-8") as f:
        json.dump(dataset, f, ensure_ascii=False, indent=2)

    print(f"âœ… å·²æ·»åŠ æµ‹è¯•ç”¨ä¾‹ #{len(dataset)}: {query}")
    print(f"   æ–‡ä»¶: {test_file}")
    if not expected:
        print("   âš ï¸  è¯·è¡¥å…… ground_truth å­—æ®µ")


def run_quick_test():
    """è¿è¡Œå¿«é€Ÿæµ‹è¯•"""
    import subprocess

    result = subprocess.run(
        ["python3", "quick_verify.py"],
        cwd="/root/autodl-tmp/rag/backend",
        capture_output=True,
        text=True,
    )
    print(result.stdout[-1500:] if len(result.stdout) > 1500 else result.stdout)
    if result.stderr:
        print("é”™è¯¯:", result.stderr[-500:])


def main():
    parser = argparse.ArgumentParser(description="RAGç³»ç»Ÿæµ‹è¯•æŒ‡å—")
    parser.add_argument("--guide", action="store_true", help="æ˜¾ç¤ºå®Œæ•´æµ‹è¯•æŒ‡å—")
    parser.add_argument("--quick", action="store_true", help="è¿è¡Œå¿«é€Ÿæµ‹è¯•")
    parser.add_argument("--add", type=str, help="æ·»åŠ æµ‹è¯•ç”¨ä¾‹ (æŸ¥è¯¢å†…å®¹)")
    parser.add_argument("--expected", type=str, help="æœŸæœ›ç­”æ¡ˆ (å¯é€‰)")

    args = parser.parse_args()

    if args.guide or len(sys.argv) == 1:
        print_guide()
    elif args.quick:
        run_quick_test()
    elif args.add:
        add_test_case(args.add, args.expected)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()
