<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ¥è¯¢ä¸æ£€ç´¢è¿‡ç¨‹å¯è§†åŒ– - RAG Retrieval</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
        }
        :root {
            --primary: #165DFF;
            --success: #00B42A;
            --warning: #FF7D00;
            --error: #F53F3F;
            --neutral: #86909C;
            --bg-main: #F5F7FA;
            --bg-card: #FFFFFF;
            --bg-light: #F2F3F5;
            --border: #E5E6EB;
            --text-main: #1D2129;
            --text-secondary: #4E5969;
            --text-light: #86909C;
            --shadow: 0 2px 12px 0 rgba(0,0,0,0.08);
            --radius: 8px;
            --transition: all 0.3s ease;
            --active: rgba(22,93,255,0.1);
            --highlight: #FFF7E6; /* åŒ¹é…å†…å®¹é«˜äº®è‰² */
        }
        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            min-height: 100vh;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .page-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .page-title {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .page-title small {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 400;
        }
        .back-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--primary);
            text-decoration: none;
            font-size: 14px;
        }
        .card {
            background-color: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 24px;
        }
        .card-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        .card-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-body {
            padding: 24px;
        }
        /* æ£€ç´¢é…ç½®ä¸æŸ¥è¯¢åŒº */
        .retrieval-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .form-input, .form-select {
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            outline: none;
            transition: var(--transition);
        }
        .form-input:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(22,93,255,0.1);
        }
        .query-input {
            width: 100%;
            min-height: 100px;
            resize: vertical;
            padding: 16px;
            font-size: 16px;
            margin-bottom: 20px;
        }
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background-color: var(--primary);
            color: #fff;
        }
        .btn-primary:hover {
            background-color: #0E4BDB;
        }
        .btn-default {
            background-color: var(--bg-light);
            color: var(--text-secondary);
        }
        .btn-default:hover {
            background-color: #e5e7eb;
        }
        .btn-group {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
        }
        /* æ£€ç´¢è¿‡ç¨‹å¯è§†åŒ– */
        .retrieval-process {
            padding: 20px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background-color: var(--bg-light);
            margin-bottom: 30px;
            line-height: 1.8;
            font-size: 14px;
        }
        .process-step {
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .step-icon {
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            border-radius: 50%;
            background-color: var(--primary);
            color: #fff;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .step-success {
            background-color: var(--success);
        }
        .process-tip {
            color: var(--primary);
            font-weight: 500;
        }
        /* ç›¸ä¼¼åº¦æ’åºä¸Top-Kç»“æœ */
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .result-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .similarity-score {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            background-color: rgba(22,93,255,0.1);
            color: var(--primary);
            font-size: 12px;
            font-weight: 500;
        }
        .score-high {
            background-color: rgba(0,180,42,0.1);
            color: var(--success);
        }
        .score-middle {
            background-color: rgba(255,125,0.1);
            color: var(--warning);
        }
        .score-low {
            background-color: rgba(134,144,156,0.1);
            color: var(--neutral);
        }
        .result-list {
            width: 100%;
            border-collapse: collapse;
        }
        .result-list th, .result-list td {
            padding: 16px 24px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }
        .result-list th {
            background-color: var(--bg-light);
            color: var(--text-secondary);
            font-weight: 500;
        }
        .result-list tr:hover {
            background-color: var(--active);
        }
        .chunk-num {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            background-color: var(--primary);
            color: #fff;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .chunk-content {
            line-height: 1.6;
            max-width: 800px;
        }
        .highlight {
            background-color: var(--highlight);
            padding: 2px 4px;
            border-radius: 2px;
            color: var(--warning);
            font-weight: 500;
        }
        /* ç©ºçŠ¶æ€ã€åŠ è½½ */
        .empty-box {
            padding: 60px 20px;
            text-align: center;
            color: var(--text-light);
            font-size: 14px;
        }
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--border);
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* é€‚é…å°å± */
        @media (max-width: 1200px) {
            .chunk-content {
                max-width: 500px;
            }
        }
        @media (max-width: 992px) {
            .retrieval-config {
                grid-template-columns: repeat(2, 1fr);
            }
            .result-list th, .result-list td {
                padding: 12px 16px;
            }
            .chunk-content {
                max-width: 300px;
            }
        }
        @media (max-width: 576px) {
            .retrieval-config {
                grid-template-columns: 1fr;
            }
            .result-list th:nth-child(4), .result-list td:nth-child(4) {
                display: none;
            }
            .btn-group {
                flex-wrap: wrap;
            }
        }
    </style>
    <!-- å­—ä½“å›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- EChartsï¼šç›¸ä¼¼åº¦æ’åºå¯è§†åŒ– -->
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-search"></i> æŸ¥è¯¢ä¸æ£€ç´¢è¿‡ç¨‹å¯è§†åŒ–
                <small>RAG Retrieval åŒ¹é… & ç»“æœå±•ç¤º</small>
            </h1>
            <div>
                <a href="javascript:;" class="back-btn"><i class="fas fa-arrow-left"></i> è¿”å›å‘é‡ç´¢å¼•</a>
                <a href="javascript:;" class="back-btn" style="margin-left:10px;"><i class="fas fa-arrow-left"></i> è¿”å›æ–‡æ¡£ç®¡ç†</a>
            </div>
        </div>

        <!-- æ£€ç´¢é…ç½®ä¸æŸ¥è¯¢å¡ç‰‡ -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-cog"></i> æ£€ç´¢é…ç½®ä¸æŸ¥è¯¢è¾“å…¥</h3>
                <span style="font-size:12px; color:var(--text-light);">æ£€ç´¢å¼•æ“ï¼šFAISS | å‘é‡æ¨¡å‹ï¼šBGE-base-zh-v1.5 | ç›¸ä¼¼åº¦ç®—æ³•ï¼šä½™å¼¦ç›¸ä¼¼åº¦</span>
            </div>
            <div class="card-body">
                <!-- æ£€ç´¢å‚æ•°é…ç½® -->
                <div class="retrieval-config">
                    <div class="form-item">
                        <label class="form-label">Top-K æ•°é‡</label>
                        <input type="number" class="form-input" id="topK" value="5" min="1" max="20" placeholder="è¿”å›æœ€ç›¸ä¼¼çš„Kä¸ªç‰‡æ®µ">
                    </div>
                    <div class="form-item">
                        <label class="form-label">ç›¸ä¼¼åº¦é˜ˆå€¼</label>
                        <input type="number" class="form-input" id="simThreshold" value="0.6" step="0.05" min="0.0" max="1.0" placeholder="æœ€ä½åŒ¹é…ç›¸ä¼¼åº¦">
                    </div>
                    <div class="form-item">
                        <label class="form-label">ç›¸ä¼¼åº¦ç®—æ³•</label>
                        <select class="form-select" id="simAlgo">
                            <option value="cosine">ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆæ¨èï¼‰</option>
                            <option value="euclidean">æ¬§æ°è·ç¦»</option>
                            <option value="manhattan">æ›¼å“ˆé¡¿è·ç¦»</option>
                        </select>
                    </div>
                    <div class="form-item">
                        <label class="form-label">æ£€ç´¢æ¨¡å¼</label>
                        <select class="form-select" id="retrievalMode">
                            <option value="vector">çº¯å‘é‡æ£€ç´¢</option>
                            <option value="hybrid">æ··åˆæ£€ç´¢ï¼ˆå‘é‡+å…³é”®è¯ï¼‰</option>
                        </select>
                    </div>
                </div>

                <!-- æŸ¥è¯¢è¾“å…¥æ¡† -->
                <label class="form-label">ç”¨æˆ·æŸ¥è¯¢é—®é¢˜</label>
                <textarea class="form-input query-input" id="queryInput" placeholder="è¯·è¾“å…¥æ‚¨çš„æŸ¥è¯¢é—®é¢˜ï¼Œä¾‹å¦‚ï¼šRAGçš„æ ¸å¿ƒæµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿä¼ä¸šRAGåˆ‡åˆ†æœ‰å“ªäº›åŸåˆ™ï¼Ÿ">RAGçš„æ ¸å¿ƒæµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ</textarea>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="btn-group">
                    <button class="btn btn-primary" id="retrievalBtn"><i class="fas fa-search"></i> æ‰§è¡Œæ£€ç´¢</button>
                    <button class="btn btn-default" id="resetQueryBtn"><i class="fas fa-refresh"></i> é‡ç½®é…ç½®ä¸æŸ¥è¯¢</button>
                    <button class="btn btn-default" id="clearResultBtn"><i class="fas fa-trash"></i> æ¸…ç©ºæ£€ç´¢ç»“æœ</button>
                </div>

                <!-- æ£€ç´¢è¿‡ç¨‹å¯è§†åŒ– -->
                <div class="retrieval-process" id="retrievalProcess">
                    <div class="process-tip">ğŸ” æ£€ç´¢è¿‡ç¨‹å°†åœ¨ç‚¹å‡»ã€Œæ‰§è¡Œæ£€ç´¢ã€åå®æ—¶å±•ç¤º...</div>
                </div>
            </div>
        </div>

        <!-- æ£€ç´¢ç»“æœå±•ç¤ºå¡ç‰‡ -->
        <div class="card">
            <div class="card-header">
                <div class="result-header">
                    <h3 class="card-title"><i class="fas fa-clipboard-list"></i> Top-K æ£€ç´¢ç»“æœ</h3>
                    <span id="resultCount" style="font-size:12px; color:var(--text-light);">æš‚æ— ç»“æœ | ä½™å¼¦ç›¸ä¼¼åº¦ â‰¥ 0.6</span>
                </div>
            </div>
            <div class="card-body">
                <!-- ç›¸ä¼¼åº¦æ’åºå¯è§†åŒ– -->
                <div id="simChart" style="width:100%; height:200px; margin-bottom:30px; display:none;"></div>
                
                <!-- ç»“æœåˆ—è¡¨ -->
                <table class="result-list" id="resultTable">
                    <thead>
                        <tr>
                            <th width="8%">ç‰‡æ®µç¼–å·</th>
                            <th width="50%">åŒ¹é…ç‰‡æ®µå†…å®¹ï¼ˆé«˜äº®åŒ¹é…å…³é”®è¯ï¼‰</th>
                            <th width="15%">ç›¸ä¼¼åº¦åˆ†æ•°</th>
                            <th width="12%">å‘é‡çŠ¶æ€</th>
                            <th width="15%">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="resultTableBody">
                        <tr>
                            <td colspan="5">
                                <div class="empty-box">
                                    <div class="empty-icon"><i class="fas fa-search"></i></div>
                                    <p>è¯·è¾“å…¥æŸ¥è¯¢é—®é¢˜å¹¶ç‚¹å‡»ã€Œæ‰§è¡Œæ£€ç´¢ã€ï¼ŒæŸ¥çœ‹Top-KåŒ¹é…ç»“æœ</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let chunkVecList = []; // å·²å‘é‡åŒ–çš„ç‰‡æ®µåˆ—è¡¨ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
        let retrievalResult = []; // æ£€ç´¢ç»“æœåˆ—è¡¨
        // å…ƒç´ è·å–
        const topK = document.getElementById('topK');
        const simThreshold = document.getElementById('simThreshold');
        const simAlgo = document.getElementById('simAlgo');
        const retrievalMode = document.getElementById('retrievalMode');
        const queryInput = document.getElementById('queryInput');
        const retrievalBtn = document.getElementById('retrievalBtn');
        const resetQueryBtn = document.getElementById('resetQueryBtn');
        const clearResultBtn = document.getElementById('clearResultBtn');
        const retrievalProcess = document.getElementById('retrievalProcess');
        const resultCount = document.getElementById('resultCount');
        const simChart = document.getElementById('simChart');
        const resultTableBody = document.getElementById('resultTableBody');
        // EChartså®ä¾‹
        let simEChart = null;

        // é¡µé¢åˆå§‹åŒ–ï¼šç”Ÿæˆæ¨¡æ‹Ÿå·²å‘é‡åŒ–ç‰‡æ®µæ•°æ®ï¼ˆ15ä¸ªï¼Œä¸å‘é‡æ¨¡å—ä¸€è‡´ï¼‰
        window.onload = function() {
            generateMockChunkVecData();
            bindEvent();
        };

        // ç”Ÿæˆæ¨¡æ‹Ÿå·²å‘é‡åŒ–ç‰‡æ®µæ•°æ®
        function generateMockChunkVecData() {
            const mockContents = [
                "# ä¼ä¸šRAGæŠ€æœ¯ç™½çš®ä¹¦",
                "æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰æ˜¯å°†ä¿¡æ¯æ£€ç´¢ä¸å¤§è¯­è¨€æ¨¡å‹ç»“åˆçš„ç”Ÿæˆå¼AIæŠ€æœ¯",
                "RAGæ ¸å¿ƒè§£å†³å¤§æ¨¡å‹å¹»è§‰ã€çŸ¥è¯†è¿‡æ—¶ä¸¤å¤§æ ¸å¿ƒé—®é¢˜",
                "RAGçš„æ ¸å¿ƒæµç¨‹åˆ†ä¸ºå››æ­¥ï¼šæ–‡æ¡£åŠ è½½ä¸é¢„å¤„ç†ã€æ–‡æ¡£åˆ‡åˆ†ä¸å‘é‡åŒ–ã€æ£€ç´¢åŒ¹é…ã€ç”Ÿæˆå›ç­”",
                "æ–‡æ¡£åˆ‡åˆ†æ˜¯RAGçš„å…³é”®ç¯èŠ‚ï¼Œåˆ‡åˆ†ç²’åº¦ç›´æ¥å½±å“æ£€ç´¢ç²¾åº¦å’Œç”Ÿæˆæ•ˆæœ",
                "ä¼ä¸šçº§RAGæ–‡æ¡£åˆ‡åˆ†éœ€éµå¾ªç²’åº¦é€‚é…ã€è¯­ä¹‰å®Œæ•´ã€é‡å äº’è¡¥ã€åŠ¨æ€è°ƒæ•´å››å¤§åŸåˆ™",
                "æŒ‰å­—ç¬¦åˆ‡åˆ†ï¼šå®ç°ç®€å•ã€é€šç”¨æ€§å¼ºï¼Œé€‚åˆæ— æ˜æ˜¾æ ¼å¼çš„çº¯æ–‡æœ¬",
                "æŒ‰å¥å­åˆ‡åˆ†ï¼šè¯­ä¹‰å®Œæ•´æ€§é«˜ï¼Œå¯¹åˆ†å¥ç¬¦æ•æ„Ÿï¼Œé€‚åˆä¸­æ–‡ä¹¦é¢æ–‡æ¡£",
                "æŒ‰æ®µè½åˆ‡åˆ†ï¼šè¯­ä¹‰ç‹¬ç«‹æ€§æœ€å¼ºï¼Œç‰‡æ®µé•¿åº¦ä¸å‡ï¼Œé€‚åˆæ’ç‰ˆè§„èŒƒçš„æ–‡æ¡£",
                "è‡ªå®šä¹‰è§„åˆ™åˆ‡åˆ†ï¼šé€‚é…ä¸ªæ€§åŒ–ä¸šåŠ¡ï¼Œéœ€è¦äººå·¥é…ç½®è§„åˆ™",
                "å‘é‡åµŒå…¥ï¼ˆEmbeddingï¼‰æ˜¯å°†æ–‡æœ¬ç‰‡æ®µè½¬ä¸ºæ•°å€¼å‘é‡çš„è¿‡ç¨‹",
                "å¸¸ç”¨çš„ä¸­æ–‡Embeddingæ¨¡å‹æœ‰BGE-baseã€text2vecã€ernie-embeddingç­‰",
                "å‘é‡ç»´åº¦å¸¸è§ä¸º768dã€1024dï¼Œç»´åº¦è¶Šé«˜è¡¨ç¤ºèƒ½åŠ›è¶Šå¼ºä½†å­˜å‚¨æˆæœ¬è¶Šé«˜",
                "å‘é‡ç´¢å¼•å¼•æ“å¸¸ç”¨FAISSã€Milvusã€Pineconeï¼Œç”¨äºå¿«é€Ÿæ£€ç´¢ç›¸ä¼¼å‘é‡",
                "ä¼ä¸šRAGè½åœ°éœ€å…¼é¡¾æ£€ç´¢ç²¾åº¦ã€ç”Ÿæˆé€Ÿåº¦ã€éƒ¨ç½²æˆæœ¬ä¸‰å¤§å› ç´ "
            ];
            // æ¨¡æ‹Ÿæ¯ä¸ªç‰‡æ®µçš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆ0.5-0.98ï¼‰ã€å‘é‡çŠ¶æ€
            chunkVecList = mockContents.map((content, index) => ({
                id: `c${index+1}`,
                num: index+1,
                content: content,
                vecStatus: 'success', // å·²å‘é‡åŒ–
                vecSim: Math.random() * 0.48 + 0.5, // æ¨¡æ‹Ÿç›¸ä¼¼åº¦
                matchKeywords: [] // åŒ¹é…å…³é”®è¯ï¼Œç”¨äºé«˜äº®
            }));
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvent() {
            // æ‰§è¡Œæ£€ç´¢
            retrievalBtn.addEventListener('click', executeRetrieval);
            // é‡ç½®é…ç½®ä¸æŸ¥è¯¢
            resetQueryBtn.addEventListener('click', resetRetrieval);
            // æ¸…ç©ºç»“æœ
            clearResultBtn.addEventListener('click', clearRetrievalResult);
            // è¾“å…¥æ¡†å›è½¦æ£€ç´¢
            queryInput.addEventListener('keydown', e => {
                if (e.ctrlKey && e.key === 'Enter') executeRetrieval();
            });
        }

        // æ‰§è¡Œæ£€ç´¢ï¼ˆæ¨¡æ‹ŸRAGå®Œæ•´æ£€ç´¢æµç¨‹ï¼‰
        function executeRetrieval() {
            // åŸºç¡€æ ¡éªŒ
            const query = queryInput.value.trim();
            const k = parseInt(topK.value);
            const threshold = parseFloat(simThreshold.value);
            if (!query) {
                alert('è¯·è¾“å…¥æŸ¥è¯¢é—®é¢˜ï¼');
                queryInput.focus();
                return;
            }
            if (isNaN(k) || k < 1 || k > 20) {
                alert('Top-Kæ•°é‡è¯·è¾“å…¥1-20ä¹‹é—´çš„æ•°å­—ï¼');
                topK.focus();
                return;
            }
            if (isNaN(threshold) || threshold < 0 || threshold > 1) {
                alert('ç›¸ä¼¼åº¦é˜ˆå€¼è¯·è¾“å…¥0.0-1.0ä¹‹é—´çš„æ•°å­—ï¼');
                simThreshold.focus();
                return;
            }

            // æ¸…ç©ºå†å²ç»“æœ
            retrievalResult = [];
            resultTableBody.innerHTML = '';
            simChart.style.display = 'none';
            if (simEChart) simEChart.dispose();

            // æ­¥éª¤1ï¼šåˆå§‹åŒ–æ£€ç´¢è¿‡ç¨‹
            initRetrievalProcess();
            // æ¨¡æ‹Ÿå¼‚æ­¥æ£€ç´¢æµç¨‹ï¼ˆé€æ­¥éª¤æ‰§è¡Œï¼Œè´´åˆçœŸå®RAGï¼‰
            setTimeout(() => step1QueryEmbedding(query), 500);
            setTimeout(() => step2SimCalculate(k, threshold, query), 1500);
            setTimeout(() => step3ResultFilter(k, threshold), 2500);
            setTimeout(() => step4ResultShow(), 3000);
        }

        // åˆå§‹åŒ–æ£€ç´¢è¿‡ç¨‹å±•ç¤º
        function initRetrievalProcess() {
            retrievalProcess.innerHTML = `
                <div class="process-step">
                    <div class="step-icon">1</div>
                    <div><b>æ£€ç´¢åˆå§‹åŒ–</b>ï¼šè·å–æ£€ç´¢å‚æ•°ï¼ˆTop-K=${topK.value}ï¼Œç›¸ä¼¼åº¦é˜ˆå€¼=${simThreshold.value}ï¼Œç®—æ³•=${simAlgo.options[simAlgo.selectedIndex].text}ï¼‰</div>
                </div>
                <div class="process-step">
                    <div class="step-icon loading" style="background:var(--neutral);"></div>
                    <div>æ­£åœ¨å°†æŸ¥è¯¢é—®é¢˜å‘é‡åŒ–...</div>
                </div>
            `;
        }

        // æ­¥éª¤1ï¼šæŸ¥è¯¢é—®é¢˜å‘é‡åŒ–
        function step1QueryEmbedding(query) {
            retrievalProcess.innerHTML += `
                <div class="process-step">
                    <div class="step-icon step-success">2</div>
                    <div><b>æŸ¥è¯¢å‘é‡åŒ–å®Œæˆ</b>ï¼šåŸºäºBGE-base-zh-v1.5å°†æŸ¥è¯¢ã€Œ${query}ã€è½¬ä¸º768ç»´å‘é‡ï¼Œç”Ÿæˆè€—æ—¶32ms</div>
                </div>
                <div class="process-step">
                    <div class="step-icon loading" style="background:var(--neutral);"></div>
                    <div>æ­£åœ¨ä¸æ–‡æ¡£å‘é‡è®¡ç®—${simAlgo.options[simAlgo.selectedIndex].text}...</div>
                </div>
            `;
        }

        // æ­¥éª¤2ï¼šç›¸ä¼¼åº¦è®¡ç®—
        function step2SimCalculate(k, threshold, query) {
            // æå–æŸ¥è¯¢å…³é”®è¯ï¼ˆç”¨äºé«˜äº®ï¼‰
            const keywords = extractKeywords(query);
            // æ¨¡æ‹Ÿç›¸ä¼¼åº¦è®¡ç®—ï¼Œæ›´æ–°æ¯ä¸ªç‰‡æ®µçš„ç›¸ä¼¼åº¦ï¼ˆè´´åˆæŸ¥è¯¢è¯­ä¹‰ï¼‰
            chunkVecList = chunkVecList.map(item => {
                let sim = item.vecSim;
                // åŒ…å«å…³é”®è¯çš„ç‰‡æ®µï¼Œç›¸ä¼¼åº¦æé«˜0.1-0.2
                keywords.forEach(key => {
                    if (item.content.includes(key)) {
                        sim = Math.min(sim + Math.random() * 0.2 + 0.1, 0.99);
                    }
                });
                return {
                    ...item,
                    vecSim: sim.toFixed(4) * 1,
                    matchKeywords: keywords.filter(key => item.content.includes(key))
                };
            });
            // è¿‡ç¨‹å±•ç¤º
            retrievalProcess.innerHTML += `
                <div class="process-step">
                    <div class="step-icon step-success">3</div>
                    <div><b>ç›¸ä¼¼åº¦è®¡ç®—å®Œæˆ</b>ï¼šä¸15ä¸ªæ–‡æ¡£å‘é‡å®Œæˆ${simAlgo.options[simAlgo.selectedIndex].text}è®¡ç®—ï¼Œæå–åŒ¹é…å…³é”®è¯ã€Œ${keywords.join('ã€')}ã€</div>
                </div>
                <div class="process-step">
                    <div class="step-icon loading" style="background:var(--neutral);"></div>
                    <div>æ­£åœ¨æŒ‰Top-K=${k}å’Œé˜ˆå€¼${threshold}ç­›é€‰ç»“æœ...</div>
                </div>
            `;
        }

        // æ­¥éª¤3ï¼šç»“æœç­›é€‰ï¼ˆæŒ‰ç›¸ä¼¼åº¦é™åºã€é˜ˆå€¼ã€Top-Kï¼‰
        function step3ResultFilter(k, threshold) {
            // ç­›é€‰ï¼šç›¸ä¼¼åº¦â‰¥é˜ˆå€¼ â†’ é™åºæ’åº â†’ å–Top-K
            retrievalResult = chunkVecList
                .filter(item => item.vecSim >= threshold)
                .sort((a, b) => b.vecSim - a.vecSim)
                .slice(0, k);
            // è¿‡ç¨‹å±•ç¤º
            retrievalProcess.innerHTML += `
                <div class="process-step">
                    <div class="step-icon step-success">4</div>
                    <div><b>ç»“æœç­›é€‰å®Œæˆ</b>ï¼šä»15ä¸ªç‰‡æ®µä¸­ç­›é€‰å‡º${retrievalResult.length}ä¸ªç¬¦åˆæ¡ä»¶çš„ç‰‡æ®µï¼ŒæŒ‰ç›¸ä¼¼åº¦é™åºæ’åˆ—</div>
                </div>
                <div class="process-step">
                    <div class="step-icon step-success">5</div>
                    <div class="process-tip">æ£€ç´¢å®Œæˆï¼å…±è€—æ—¶${Math.floor(Math.random() * 200) + 300}msï¼Œå±•ç¤ºTop-${Math.min(k, retrievalResult.length)}åŒ¹é…ç»“æœ</div>
                </div>
            `;
        }

        // æ­¥éª¤4ï¼šç»“æœå±•ç¤ºï¼ˆåˆ—è¡¨+ç›¸ä¼¼åº¦å¯è§†åŒ–ï¼‰
        function step4ResultShow() {
            const k = parseInt(topK.value);
            const threshold = parseFloat(simThreshold.value);
            // æ›´æ–°ç»“æœç»Ÿè®¡
            resultCount.innerText = `å…±${retrievalResult.length}ä¸ªåŒ¹é…ç»“æœ | ${simAlgo.options[simAlgo.selectedIndex].text} â‰¥ ${threshold} | Top-K=${k}`;
            
            // æ— ç»“æœ
            if (retrievalResult.length === 0) {
                resultTableBody.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="empty-box">
                                <div class="empty-icon"><i class="fas fa-search"></i></div>
                                <p>æœªæ£€ç´¢åˆ°ç¬¦åˆæ¡ä»¶çš„ç‰‡æ®µï¼Œè¯·é™ä½ç›¸ä¼¼åº¦é˜ˆå€¼æˆ–ä¿®æ”¹æŸ¥è¯¢é—®é¢˜</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            // æ¸²æŸ“ç›¸ä¼¼åº¦æ’åºå¯è§†åŒ–å›¾è¡¨
            renderSimChart();
            // æ¸²æŸ“Top-Kç»“æœåˆ—è¡¨
            renderResultList();
        }

        // æå–æŸ¥è¯¢å…³é”®è¯ï¼ˆç®€å•åˆ†è¯ï¼Œç”¨äºé«˜äº®ï¼‰
        function extractKeywords(query) {
            // è¿‡æ»¤æ ‡ç‚¹å’Œæ— æ„ä¹‰è¯æ±‡ï¼Œæå–æ ¸å¿ƒåè¯/åŠ¨è¯
            const stopWords = ['çš„', 'æ˜¯', 'ä»€ä¹ˆ', 'å“ªäº›', 'æœ‰', 'å¦‚ä½•', 'æ€ä¹ˆ', 'ä¸º', 'ä¸', 'å’Œ', 'åŠ', 'åœ¨', 'äº'];
            const punctuation = /[ï¼Œã€‚ï¼ï¼Ÿï¼Ÿï¼›ï¼š""''()ï¼ˆï¼‰\[\]ã€ã€‘ã€]/g;
            return query.replace(punctuation, '').split(' ')
                .filter(word => word.trim() && !stopWords.includes(word) && word.length > 1)
                .slice(0, 5); // æœ€å¤šæå–5ä¸ªå…³é”®è¯
        }

        // é«˜äº®ç‰‡æ®µä¸­çš„åŒ¹é…å…³é”®è¯
        function highlightContent(content, keywords) {
            if (keywords.length === 0) return content;
            // ç”Ÿæˆæ­£åˆ™ï¼Œå…¨å±€åŒ¹é…å…³é”®è¯
            const reg = new RegExp(`(${keywords.join('|')})`, 'g');
            return content.replace(reg, '<span class="highlight">$1</span>');
        }

        // æ¸²æŸ“ç›¸ä¼¼åº¦æ’åºå¯è§†åŒ–å›¾è¡¨ï¼ˆEChartsæŸ±çŠ¶å›¾ï¼‰
        function renderSimChart() {
            simChart.style.display = 'block';
            simEChart = echarts.init(simChart);
            // å‡†å¤‡æ•°æ®
            const xData = retrievalResult.map(item => `ç‰‡æ®µ${item.num}`);
            const yData = retrievalResult.map(item => item.vecSim);
            const colorData = yData.map(sim => {
                if (sim >= 0.8) return var(--success);
                else if (sim >= 0.7) return var(--primary);
                else if (sim >= 0.6) return var(--warning);
                else return var(--neutral);
            });
            // é…ç½®é¡¹
            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: 'ç‰‡æ®µ{b}ï¼š{c}<br/>ç›¸ä¼¼åº¦ï¼š{c}'
                },
                xAxis: {
                    type: 'category',
                    data: xData,
                    axisLabel: { interval: 0 }
                },
                yAxis: {
                    type: 'value',
                    min: parseFloat(simThreshold.value) - 0.1,
                    max: 1.0,
                    name: 'ç›¸ä¼¼åº¦',
                    nameTextStyle: { color: var(--text-secondary) }
                },
                grid: { top: 30, bottom: 40, left: 60, right: 20 },
                series: [{
                    name: 'ç›¸ä¼¼åº¦',
                    type: 'bar',
                    data: yData.map((val, i) => ({ value: val, itemStyle: { color: colorData[i] } })),
                    barWidth: '60%',
                    label: {
                        show: true,
                        position: 'top',
                        formatter: '{c}',
                        fontSize: 12
                    }
                }]
            };
            simEChart.setOption(option);
            window.addEventListener('resize', () => simEChart.resize());
        }

        // æ¸²æŸ“Top-Kç»“æœåˆ—è¡¨
        function renderResultList() {
            resultTableBody.innerHTML = '';
            // ç›¸ä¼¼åº¦åˆ†æ•°æ ·å¼æ˜ å°„
            const getScoreClass = (sim) => {
                if (sim >= 0.8) return 'score-high';
                else if (sim >= 0.7) return 'similarity-score';
                else if (sim >= 0.6) return 'score-middle';
                else return 'score-low';
            };
            // æ¸²æŸ“æ¯ä¸ªç»“æœ
            retrievalResult.forEach(item => {
                const tr = document.createElement('tr');
                // é«˜äº®åŒ¹é…å†…å®¹
                const highlightContentHtml = highlightContent(item.content, item.matchKeywords);
                tr.innerHTML = `
                    <td><span class="chunk-num">${item.num}</span></td>
                    <td class="chunk-content">${highlightContentHtml}</td>
                    <td><span class="similarity-score ${getScoreClass(item.vecSim)}">${item.vecSim}</span></td>
                    <td><span class="similarity-score score-high"><i class="fas fa-check-circle"></i> å·²ç´¢å¼•</span></td>
                    <td>
                        <button class="btn btn-default" style="padding:6px 12px; font-size:12px;" onclick="viewChunkDetail('${item.id}')">
                            <i class="fas fa-eye"></i> æŸ¥çœ‹è¯¦æƒ…
                        </button>
                    </td>
                `;
                resultTableBody.appendChild(tr);
            });
        }

        // é‡ç½®æ£€ç´¢é…ç½®ä¸æŸ¥è¯¢
        function resetRetrieval() {
            // é‡ç½®é…ç½®
            topK.value = 5;
            simThreshold.value = 0.6;
            simAlgo.value = 'cosine';
            retrievalMode.value = 'vector';
            // é‡ç½®æŸ¥è¯¢
            queryInput.value = 'RAGçš„æ ¸å¿ƒæµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ';
            // æ¸…ç©ºç»“æœ
            clearRetrievalResult();
            // é‡ç½®è¿‡ç¨‹
            retrievalProcess.innerHTML = '<div class="process-tip">ğŸ” æ£€ç´¢è¿‡ç¨‹å°†åœ¨ç‚¹å‡»ã€Œæ‰§è¡Œæ£€ç´¢ã€åå®æ—¶å±•ç¤º...</div>';
            alert('æ£€ç´¢é…ç½®ä¸æŸ¥è¯¢å·²é‡ç½®ä¸ºé»˜è®¤å€¼ï¼');
        }

        // æ¸…ç©ºæ£€ç´¢ç»“æœ
        function clearRetrievalResult() {
            retrievalResult = [];
            resultTableBody.innerHTML = `
                <tr>
                    <td colspan="5">
                        <div class="empty-box">
                            <div class="empty-icon"><i class="fas fa-search"></i></div>
                            <p>è¯·è¾“å…¥æŸ¥è¯¢é—®é¢˜å¹¶ç‚¹å‡»ã€Œæ‰§è¡Œæ£€ç´¢ã€ï¼ŒæŸ¥çœ‹Top-KåŒ¹é…ç»“æœ</p>
                        </div>
                    </td>
                </tr>
            `;
            resultCount.innerText = 'æš‚æ— ç»“æœ | ä½™å¼¦ç›¸ä¼¼åº¦ â‰¥ 0.6';
            simChart.style.display = 'none';
            if (simEChart) simEChart.dispose();
        }

        // æŸ¥çœ‹ç‰‡æ®µè¯¦æƒ…
        function viewChunkDetail(id) {
            const chunk = chunkVecList.find(item => item.id === id);
            if (!chunk) return;
            alert(`
ç‰‡æ®µ${chunk.num}è¯¦æƒ…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ ç‰‡æ®µå†…å®¹ï¼š${chunk.content}
â”‚ ç›¸ä¼¼åº¦åˆ†æ•°ï¼š${chunk.vecSim}
â”‚ åŒ¹é…å…³é”®è¯ï¼š${chunk.matchKeywords.join('ã€') || 'æ— '}
â”‚ å‘é‡çŠ¶æ€ï¼šå·²å‘é‡åŒ–Â·å·²ç´¢å¼•
â”‚ å‘é‡æ¨¡å‹ï¼šBGE-base-zh-v1.5
â”‚ æ£€ç´¢å¼•æ“ï¼šFAISS
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            `);
        }
    </script>
</body>
</html>